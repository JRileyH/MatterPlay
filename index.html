<script src="matter-evolve.js"></script>
<div>
    <button onclick="createComp()">spawn</button>
    <button onclick="dupeComp()">dupe</button>
</div>
<script>

// module aliases
var Engine = Matter.Engine,
    Render = Matter.Render,
    World = Matter.World,
    Bodies = Matter.Bodies,
    Common = Matter.Common,
    Composite = Matter.Composite,
    Constraint = Matter.Constraint;
    Runner = Matter.Runner;

//creation properties
var creationProperties = {
    //SPAWN
    x: 200,
    y: 100,

    //CREATURE
    maxWidth: 350,
    minWidth: 50,
    maxHeight: 350,
    minHeight: 50,

    //FEET
    maxFootNumber: 6,
    minFootNumber: 2,
    maxFootSize: 30,
    minFootSize: 5,
    maxFootFaces: 8,
    minFootFaces: 1,

    //LEGS
    maxWiggleRoom: 15,
    minWiggleRoom: 5

}

//creation action
function createComp() {
    World.add(engine.world, makeCreature(creationProperties));
}
function dupeComp() {
    World.add(engine.world, dupeCreature(lastCreature));
}

function randomSpan(min,max)
{
    return Math.floor(Math.random()*(max-min+1)+min);
}

function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}

//random creature creation
var lastCreature = null;
var makeCreature = function(props){
    var creature = Composite.create({ label: 'Creature' });
    creature.attributes = {
        width: randomSpan(props.minWidth, props.maxWidth),
        height: randomSpan(props.minHeight, props.maxHeight),
        numberOfFeet: randomSpan(props.minFootNumber, props.maxFootNumber),
        feet: [],
        legs: []
    };

    for(var i = 0; i < creature.attributes.numberOfFeet; i++) {
        var footSize = randomSpan(props.minFootSize, props.maxFootSize);
        var xSpawn = props.x + randomSpan(0, creature.attributes.width) - Math.floor(footSize / 2);
        var ySpawn = props.y + randomSpan(0, creature.attributes.height) - Math.floor(footSize / 2);
        
        var body = i===0 ? Bodies.circle(xSpawn, ySpawn, footSize, {
            render: {
                fillStyle: '#bbb',
                strokeStyle: '#111',
                lineWidth: 2
            }
        }) : Bodies.circle(xSpawn, ySpawn, footSize, {
            render: {
                fillStyle: '#333',
                strokeStyle: '#111',
                lineWidth: 2
            }
        })

        body.order = i;

        creature.attributes.feet.push({
            x: xSpawn,
            y: ySpawn,
            size: footSize,
            order: i
        });
        Composite.addBody(creature, body);
    }
    var makeLegs = function(creature, feet, chance) {
        if(feet.length>0) {
            chance = chance || 1;
            var index = randomSpan(0, feet.length-1);
            var footA = feet[index];

            var usableFeet = feet.filter(function(x){return x.id != footA.id});
            usableFeet = shuffle(usableFeet);
            for(var i in usableFeet) {
                var footB = usableFeet[i];
                if(Math.random()<chance) {
                    Composite.addConstraint(creature, Constraint.create(Common.extend({ bodyA: footA, bodyB: footB })));
                    creature.attributes.legs.push({
                        a: footA.order,
                        b: footB.order
                    });
                    chance /= 3;
                }
            }
            makeLegs(creature, usableFeet);
        }
    };
    makeLegs(creature, creature.bodies);

    //refit the creature
    var refit = function(){
        for(var i in creature.constraints){
            creature.constraints[i].expanding = Math.random()>0.5;
            creature.attributes.legs[i].expanding = creature.constraints[i].expanding;

            creature.constraints[i].wiggleRoom = randomSpan(props.minWiggleRoom, props.maxWiggleRoom);
            creature.attributes.legs[i].wiggleRoom = creature.constraints[i].wiggleRoom;

            creature.constraints[i].staticLength = creature.constraints[i].length;
            creature.attributes.legs[i].staticLength = creature.constraints[i].staticLength;

            var bodyLength = creature.constraints[i].bodyA.circleRadius+creature.constraints[i].bodyB.circleRadius;
            if(creature.constraints[i].length<bodyLength+3){
                creature.constraints[i].length = bodyLength+3;
                refit();
                break;
            }
        }
    }
    refit();

    //add the motion function
    creature.flex = function(){
        for(var i in this.constraints){
            var c = this.constraints[i];
            if(c.expanding){
                if(c.length >= c.staticLength+c.wiggleRoom){
                    c.expanding = false;
                } else {
                    c.length++;
                }
            } else {
                if(c.length <= c.staticLength-c.wiggleRoom || c.length < (c.bodyA.circleRadius+c.bodyB.circleRadius+3)){
                    c.expanding = true;
                } else {
                    c.length--;
                }
            }
        }
    }
    console.log(creature);
    var temp = {};
    lastCreature = creature.attributes;
    return creature;
}

//random creature creation
var dupeCreature = function(gene){
    var creature = Composite.create({ label: 'Creature' });
    //mutate here
    creature.attributes = {
        width: gene.width,
        height: gene.height,
        numberOfFeet: gene.numberOfFeet,
        feet: gene.feet,
        legs: gene.legs
    };

    console.log(gene.legs);

    for(var i = 0; i < gene.feet.length; i++) {
        var footSize = gene.feet[i].size;
        var xSpawn = gene.feet[i].x;
        var ySpawn = gene.feet[i].y;
        
        var body = i===0 ? Bodies.circle(xSpawn, ySpawn, footSize, {
            render: {
                fillStyle: '#bbb',
                strokeStyle: '#111',
                lineWidth: 2
            }
        }) : Bodies.circle(xSpawn, ySpawn, footSize, {
            render: {
                fillStyle: '#333',
                strokeStyle: '#111',
                lineWidth: 2
            }
        })
        body.order = i;
        Composite.addBody(creature, body);
    }

    //make Legs
    for(var i = 0; i < gene.legs.length; i++) {
        var footA = creature.bodies.filter(function(x){return x.order==gene.legs[i].a})[0];
        var footB = creature.bodies.filter(function(x){return x.order==gene.legs[i].b})[0];

        Composite.addConstraint(creature, Constraint.create(Common.extend({
            bodyA: footA,
            bodyB: footB
        })));
        
        creature.constraints[i].expanding = gene.legs[i].expanding;
        creature.constraints[i].wiggleRoom = gene.legs[i].wiggleRoom;
        creature.constraints[i].staticLength = gene.legs[i].staticLength;
    }

    //refit the creature


    //add the motion function
    creature.flex = function(){
        for(var i in this.constraints){
            var c = this.constraints[i];
            if(c.expanding){
                if(c.length >= c.staticLength+c.wiggleRoom){
                    c.expanding = false;
                } else {
                    c.length++;
                }
            } else {
                if(c.length <= c.staticLength-c.wiggleRoom || c.length < (c.bodyA.circleRadius+c.bodyB.circleRadius+3)){
                    c.expanding = true;
                } else {
                    c.length--;
                }
            }
        }
    }

    console.log(creature);
    return creature;
}

// create an engine
var engine = Engine.create();

// create a renderer
var render = Render.create({
    element: document.body,
    engine: engine
});
render.options.wireframes = false;

var ground = Bodies.rectangle(400, 610, 810, 60, { isStatic: true });
var wallR = Bodies.rectangle(10, 300, 5, 550, { isStatic: true });
var wallL = Bodies.rectangle(790, 300, 5, 550, { isStatic: true });
World.add(engine.world, [ground, wallR, wallL]);

// run the engine
var runner = Engine.run(engine, null, function(){
    for(var i in engine.world.composites){
        var creature = engine.world.composites[i];
        if(creature.hasOwnProperty('flex')){
            creature.flex();
        }
    }
});

// run the renderer
Render.run(render);

</script>